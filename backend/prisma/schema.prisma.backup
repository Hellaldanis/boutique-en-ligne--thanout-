generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id                      BigInt              @id @default(autoincrement()) @map("user_id")
  email                   String              @unique @db.VarChar(255)
  passwordHash            String              @map("password_hash") @db.VarChar(255)
  firstName               String              @map("first_name") @db.VarChar(100)
  lastName                String              @map("last_name") @db.VarChar(100)
  phone                   String?             @db.VarChar(20)
  dateOfBirth             DateTime?           @map("date_of_birth") @db.Date
  avatarUrl               String?             @map("avatar_url") @db.VarChar(500)
  isActive                Boolean             @default(true) @map("is_active")
  isVerified              Boolean             @default(false) @map("is_verified")
  emailVerificationToken  String?             @map("email_verification_token") @db.VarChar(255)
  passwordResetToken      String?             @map("password_reset_token") @db.VarChar(255)
  passwordResetExpires    DateTime?           @map("password_reset_expires")
  lastLogin               DateTime?           @map("last_login")
  accountSuspended        Boolean             @default(false) @map("account_suspended")
  suspensionReason        String?             @map("suspension_reason")
  createdAt               DateTime            @default(now()) @map("created_at")
  updatedAt               DateTime            @updatedAt @map("updated_at")

  addresses               UserAddress[]
  orders                  Order[]
  reviews                 ProductReview[]
  favorites               Favorite[]
  cart                    Cart?
  notifications           Notification[]
  adminUser               AdminUser?
  promoCodeUsages         PromoCodeUsage[]
  returns                 Return[]
  activityLogs            ActivityLog[]       @relation("UserLogs")
  contactMessages         ContactMessage[]
  reviewHelpful           ReviewHelpful[]

  @@index([email])
  @@index([isActive])
  @@index([createdAt])
  @@map("users")
}

model UserAddress {
  id              BigInt   @id @default(autoincrement()) @map("address_id")
  userId          BigInt   @map("user_id")
  addressType     String   @map("address_type") @db.VarChar(20)
  fullName        String   @map("full_name") @db.VarChar(200)
  phone           String   @db.VarChar(20)
  addressLine1    String   @map("address_line1") @db.VarChar(255)
  addressLine2    String?  @map("address_line2") @db.VarChar(255)
  city            String   @db.VarChar(100)
  wilaya          String   @db.VarChar(100)
  postalCode      String?  @map("postal_code") @db.VarChar(20)
  country         String   @default("Algérie") @db.VarChar(100)
  isDefault       Boolean  @default(false) @map("is_default")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, isDefault])
  @@map("user_addresses")
}

model Category {
  id              Int       @id @default(autoincrement()) @map("category_id")
  name            String    @unique @db.VarChar(100)
  slug            String    @unique @db.VarChar(100)
  description     String?
  parentCategoryId Int?     @map("parent_category_id")
  imageUrl        String?   @map("image_url") @db.VarChar(500)
  isActive        Boolean   @default(true) @map("is_active")
  displayOrder    Int       @default(0) @map("display_order")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  parentCategory  Category? @relation("CategoryToCategory", fields: [parentCategoryId], references: [id], onDelete: SetNull)
  subCategories   Category[] @relation("CategoryToCategory")
  products        Product[]

  @@index([slug])
  @@index([parentCategoryId])
  @@index([isActive])
  @@map("categories")
}

model Brand {
  id          Int       @id @default(autoincrement()) @map("brand_id")
  name        String    @unique @db.VarChar(100)
  slug        String    @unique @db.VarChar(100)
  description String?
  logoUrl     String?   @map("logo_url") @db.VarChar(500)
  websiteUrl  String?   @map("website_url") @db.VarChar(500)
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  products    Product[]

  @@index([slug])
  @@index([isActive])
  @@map("brands")
}

model Product {
  id                  BigInt            @id @default(autoincrement()) @map("product_id")
  categoryId          Int               @map("category_id")
  brandId             Int?              @map("brand_id")
  name                String            @db.VarChar(255)
  slug                String            @unique @db.VarChar(255)
  description         String?
  shortDescription    String?           @map("short_description") @db.VarChar(500)
  price               Decimal           @db.Decimal(10, 2)
  oldPrice            Decimal?          @map("old_price") @db.Decimal(10, 2)
  costPrice           Decimal?          @map("cost_price") @db.Decimal(10, 2)
  discountPercentage  Int?              @map("discount_percentage")
  stockQuantity       Int               @default(0) @map("stock_quantity")
  lowStockThreshold   Int               @default(5) @map("low_stock_threshold")
  sku                 String?           @unique @db.VarChar(100)
  barcode             String?           @db.VarChar(100)
  weight              Decimal?          @db.Decimal(8, 2)
  weightUnit          String?           @default("kg") @map("weight_unit") @db.VarChar(10)
  isActive            Boolean           @default(true) @map("is_active")
  isFeatured          Boolean           @default(false) @map("is_featured")
  isNew               Boolean           @default(false) @map("is_new")
  isBestseller        Boolean           @default(false) @map("is_bestseller")
  viewCount           Int               @default(0) @map("view_count")
  metaTitle           String?           @map("meta_title") @db.VarChar(255)
  metaDescription     String?           @map("meta_description")
  metaKeywords        String?           @map("meta_keywords") @db.VarChar(500)
  createdAt           DateTime          @default(now()) @map("created_at")
  updatedAt           DateTime          @updatedAt @map("updated_at")

  category            Category          @relation(fields: [categoryId], references: [id], onDelete: Restrict)
  brand               Brand?            @relation(fields: [brandId], references: [id], onDelete: SetNull)
  images              ProductImage[]
  variants            ProductVariant[]
  features            ProductFeature[]
  tags                ProductTag[]
  reviews             ProductReview[]
  favorites           Favorite[]
  cartItems           CartItem[]
  orderItems          OrderItem[]

  @@index([categoryId])
  @@index([brandId])
  @@index([slug])
  @@index([isActive])
  @@index([isFeatured])
  @@index([isNew])
  @@index([price])
  @@index([stockQuantity])
  @@index([createdAt])
  @@map("products")
}

model ProductImage {
  id            BigInt   @id @default(autoincrement()) @map("image_id")
  productId     BigInt   @map("product_id")
  imageUrl      String   @map("image_url") @db.VarChar(500)
  altText       String?  @map("alt_text") @db.VarChar(255)
  displayOrder  Int      @default(0) @map("display_order")
  isPrimary     Boolean  @default(false) @map("is_primary")
  createdAt     DateTime @default(now()) @map("created_at")

  product       Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([productId, isPrimary])
  @@map("product_images")
}

model ProductVariant {
  id              BigInt     @id @default(autoincrement()) @map("variant_id")
  productId       BigInt     @map("product_id")
  variantType     String     @map("variant_type") @db.VarChar(50)
  variantValue    String     @map("variant_value") @db.VarChar(100)
  priceAdjustment Decimal    @default(0) @map("price_adjustment") @db.Decimal(10, 2)
  stockQuantity   Int        @default(0) @map("stock_quantity")
  sku             String?    @unique @db.VarChar(100)
  isActive        Boolean    @default(true) @map("is_active")
  createdAt       DateTime   @default(now()) @map("created_at")

  product         Product    @relation(fields: [productId], references: [id], onDelete: Cascade)
  orderItems      OrderItem[]
  cartItems       CartItem[]

  @@unique([productId, variantType, variantValue])
  @@index([productId])
  @@index([variantType])
  @@map("product_variants")
}

model ProductFeature {
  id            BigInt   @id @default(autoincrement()) @map("feature_id")
  productId     BigInt   @map("product_id")
  featureName   String   @map("feature_name") @db.VarChar(100)
  featureValue  String   @map("feature_value") @db.VarChar(255)
  displayOrder  Int      @default(0) @map("display_order")
  createdAt     DateTime @default(now()) @map("created_at")

  product       Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@map("product_features")
}

model Tag {
  id        Int          @id @default(autoincrement()) @map("tag_id")
  name      String       @unique @db.VarChar(50)
  slug      String       @unique @db.VarChar(50)
  createdAt DateTime     @default(now()) @map("created_at")

  products  ProductTag[]

  @@map("tags")
}

model ProductTag {
  productId BigInt  @map("product_id")
  tagId     Int     @map("tag_id")

  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  tag       Tag     @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([productId, tagId])
  @@index([productId])
  @@index([tagId])
  @@map("product_tags")
}

model ProductReview {
  id                  BigInt           @id @default(autoincrement()) @map("review_id")
  productId           BigInt           @map("product_id")
  userId              BigInt           @map("user_id")
  rating              Int
  title               String?          @db.VarChar(200)
  comment             String
  isVerifiedPurchase  Boolean          @default(false) @map("is_verified_purchase")
  helpfulCount        Int              @default(0) @map("helpful_count")
  isApproved          Boolean          @default(false) @map("is_approved")
  adminResponse       String?          @map("admin_response")
  adminResponseAt     DateTime?        @map("admin_response_at")
  createdAt           DateTime         @default(now()) @map("created_at")
  updatedAt           DateTime         @updatedAt @map("updated_at")

  product             Product          @relation(fields: [productId], references: [id], onDelete: Cascade)
  user                User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  helpfulVotes        ReviewHelpful[]

  @@unique([productId, userId])
  @@index([productId])
  @@index([userId])
  @@index([rating])
  @@index([isApproved])
  @@map("product_reviews")
}

model ReviewHelpful {
  userId    BigInt        @map("user_id")
  reviewId  BigInt        @map("review_id")
  createdAt DateTime      @default(now()) @map("created_at")

  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  review    ProductReview @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  @@id([userId, reviewId])
  @@map("review_helpful")
}

model PromoCode {
  id                  Int                @id @default(autoincrement()) @map("promo_id")
  code                String             @unique @db.VarChar(50)
  description         String?            @db.VarChar(255)
  discountType        String             @map("discount_type") @db.VarChar(20)
  discountValue       Decimal            @map("discount_value") @db.Decimal(10, 2)
  minPurchaseAmount   Decimal            @default(0) @map("min_purchase_amount") @db.Decimal(10, 2)
  maxDiscountAmount   Decimal?           @map("max_discount_amount") @db.Decimal(10, 2)
  usageLimit          Int?               @map("usage_limit")
  usageCount          Int                @default(0) @map("usage_count")
  usagePerUser        Int                @default(1) @map("usage_per_user")
  validFrom           DateTime           @map("valid_from")
  validUntil          DateTime           @map("valid_until")
  isActive            Boolean            @default(true) @map("is_active")
  createdAt           DateTime           @default(now()) @map("created_at")
  updatedAt           DateTime           @updatedAt @map("updated_at")

  usages              PromoCodeUsage[]
  orders              Order[]

  @@index([code])
  @@index([isActive])
  @@index([validFrom, validUntil])
  @@map("promo_codes")
}

model PromoCodeUsage {
  id        BigInt    @id @default(autoincrement()) @map("usage_id")
  promoId   Int       @map("promo_id")
  userId    BigInt    @map("user_id")
  orderId   BigInt?   @map("order_id")
  usedAt    DateTime  @default(now()) @map("used_at")

  promoCode PromoCode @relation(fields: [promoId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  order     Order?    @relation(fields: [orderId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([promoId])
  @@map("promo_code_usage")
}

model Order {
  id                  BigInt              @id @default(autoincrement()) @map("order_id")
  userId              BigInt              @map("user_id")
  orderNumber         String              @unique @map("order_number") @db.VarChar(50)
  status              String              @default("pending") @db.VarChar(30)
  paymentStatus       String              @default("pending") @map("payment_status") @db.VarChar(30)
  paymentMethod       String              @map("payment_method") @db.VarChar(30)
  subtotal            Decimal             @db.Decimal(10, 2)
  shippingCost        Decimal             @default(0) @map("shipping_cost") @db.Decimal(10, 2)
  discountAmount      Decimal             @default(0) @map("discount_amount") @db.Decimal(10, 2)
  taxAmount           Decimal             @default(0) @map("tax_amount") @db.Decimal(10, 2)
  totalAmount         Decimal             @map("total_amount") @db.Decimal(10, 2)
  promoCodeId         Int?                @map("promo_code_id")
  notes               String?
  ipAddress           String?             @map("ip_address") @db.VarChar(45)
  userAgent           String?             @map("user_agent") @db.VarChar(500)
  confirmedAt         DateTime?           @map("confirmed_at")
  shippedAt           DateTime?           @map("shipped_at")
  deliveredAt         DateTime?           @map("delivered_at")
  cancelledAt         DateTime?           @map("cancelled_at")
  cancellationReason  String?             @map("cancellation_reason")
  createdAt           DateTime            @default(now()) @map("created_at")
  updatedAt           DateTime            @updatedAt @map("updated_at")

  user                User                @relation(fields: [userId], references: [id], onDelete: Restrict)
  promoCode           PromoCode?          @relation(fields: [promoCodeId], references: [id], onDelete: SetNull)
  items               OrderItem[]
  shipping            OrderShipping?
  statusHistory       OrderStatusHistory[]
  returns             Return[]
  promoCodeUsages     PromoCodeUsage[]

  @@index([userId])
  @@index([orderNumber])
  @@index([status])
  @@index([paymentStatus])
  @@index([createdAt])
  @@map("orders")
}

model OrderItem {
  id              BigInt          @id @default(autoincrement()) @map("order_item_id")
  orderId         BigInt          @map("order_id")
  productId       BigInt          @map("product_id")
  variantId       BigInt?         @map("variant_id")
  productName     String          @map("product_name") @db.VarChar(255)
  productSku      String?         @map("product_sku") @db.VarChar(100)
  variantDetails  Json?           @map("variant_details")
  unitPrice       Decimal         @map("unit_price") @db.Decimal(10, 2)
  quantity        Int
  subtotal        Decimal         @db.Decimal(10, 2)
  discountAmount  Decimal         @default(0) @map("discount_amount") @db.Decimal(10, 2)
  totalAmount     Decimal         @map("total_amount") @db.Decimal(10, 2)
  createdAt       DateTime        @default(now()) @map("created_at")

  order           Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product         Product         @relation(fields: [productId], references: [id], onDelete: Restrict)
  variant         ProductVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)
  returnItems     ReturnItem[]

  @@index([orderId])
  @@index([productId])
  @@map("order_items")
}

model OrderShipping {
  id                BigInt   @id @default(autoincrement()) @map("shipping_id")
  orderId           BigInt   @unique @map("order_id")
  fullName          String   @map("full_name") @db.VarChar(200)
  phone             String   @db.VarChar(20)
  addressLine1      String   @map("address_line1") @db.VarChar(255)
  addressLine2      String?  @map("address_line2") @db.VarChar(255)
  city              String   @db.VarChar(100)
  wilaya            String   @db.VarChar(100)
  postalCode        String?  @map("postal_code") @db.VarChar(20)
  country           String   @default("Algérie") @db.VarChar(100)
  trackingNumber    String?  @map("tracking_number") @db.VarChar(100)
  carrier           String?  @db.VarChar(100)
  shippingMethod    String?  @map("shipping_method") @db.VarChar(50)
  estimatedDelivery DateTime? @map("estimated_delivery") @db.Date
  actualDelivery    DateTime? @map("actual_delivery")
  createdAt         DateTime @default(now()) @map("created_at")

  order             Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([trackingNumber])
  @@map("order_shipping")
}

model OrderStatusHistory {
  id        BigInt   @id @default(autoincrement()) @map("history_id")
  orderId   BigInt   @map("order_id")
  oldStatus String?  @map("old_status") @db.VarChar(30)
  newStatus String   @map("new_status") @db.VarChar(30)
  notes     String?
  changedBy BigInt?  @map("changed_by")
  createdAt DateTime @default(now()) @map("created_at")

  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@map("order_status_history")
}

model Return {
  id            BigInt       @id @default(autoincrement()) @map("return_id")
  orderId       BigInt       @map("order_id")
  userId        BigInt       @map("user_id")
  returnNumber  String       @unique @map("return_number") @db.VarChar(50)
  status        String       @default("requested") @db.VarChar(30)
  reason        String       @db.VarChar(100)
  description   String?
  refundAmount  Decimal?     @map("refund_amount") @db.Decimal(10, 2)
  adminNotes    String?      @map("admin_notes")
  approvedAt    DateTime?    @map("approved_at")
  rejectedAt    DateTime?    @map("rejected_at")
  refundedAt    DateTime?    @map("refunded_at")
  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt @map("updated_at")

  order         Order        @relation(fields: [orderId], references: [id], onDelete: Restrict)
  user          User         @relation(fields: [userId], references: [id], onDelete: Restrict)
  items         ReturnItem[]

  @@index([orderId])
  @@index([userId])
  @@index([status])
  @@map("returns")
}

model ReturnItem {
  id          BigInt    @id @default(autoincrement()) @map("return_item_id")
  returnId    BigInt    @map("return_id")
  orderItemId BigInt    @map("order_item_id")
  quantity    Int
  condition   String?   @db.VarChar(50)
  createdAt   DateTime  @default(now()) @map("created_at")

  return      Return    @relation(fields: [returnId], references: [id], onDelete: Cascade)
  orderItem   OrderItem @relation(fields: [orderItemId], references: [id], onDelete: Restrict)

  @@index([returnId])
  @@map("return_items")
}

model Favorite {
  id        BigInt   @id @default(autoincrement()) @map("favorite_id")
  userId    BigInt   @map("user_id")
  productId BigInt   @map("product_id")
  createdAt DateTime @default(now()) @map("created_at")

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@index([userId])
  @@index([productId])
  @@map("favorites")
}

model Cart {
  id        BigInt     @id @default(autoincrement()) @map("cart_id")
  userId    BigInt?    @unique @map("user_id")
  sessionId String?    @map("session_id") @db.VarChar(255)
  createdAt DateTime   @default(now()) @map("created_at")
  updatedAt DateTime   @updatedAt @map("updated_at")

  user      User?      @relation(fields: [userId], references: [id], onDelete: Cascade)
  items     CartItem[]

  @@index([userId])
  @@index([sessionId])
  @@map("cart")
}

model CartItem {
  id        BigInt          @id @default(autoincrement()) @map("cart_item_id")
  cartId    BigInt          @map("cart_id")
  productId BigInt          @map("product_id")
  variantId BigInt?         @map("variant_id")
  quantity  Int
  createdAt DateTime        @default(now()) @map("created_at")
  updatedAt DateTime        @updatedAt @map("updated_at")

  cart      Cart            @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product   Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  variant   ProductVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)

  @@unique([cartId, productId, variantId])
  @@index([cartId])
  @@index([productId])
  @@map("cart_items")
}

model NewsletterSubscriber {
  id                BigInt    @id @default(autoincrement()) @map("subscriber_id")
  email             String    @unique @db.VarChar(255)
  isSubscribed      Boolean   @default(true) @map("is_subscribed")
  subscriptionToken String?   @map("subscription_token") @db.VarChar(255)
  subscribedAt      DateTime  @default(now()) @map("subscribed_at")
  unsubscribedAt    DateTime? @map("unsubscribed_at")

  @@index([email])
  @@index([isSubscribed])
  @@map("newsletter_subscribers")
}

model ContactMessage {
  id             BigInt    @id @default(autoincrement()) @map("message_id")
  name           String    @db.VarChar(200)
  email          String    @db.VarChar(255)
  subject        String    @db.VarChar(255)
  message        String
  status         String    @default("new") @db.VarChar(30)
  userId         BigInt?   @map("user_id")
  adminResponse  String?   @map("admin_response")
  respondedAt    DateTime? @map("responded_at")
  createdAt      DateTime  @default(now()) @map("created_at")

  user           User?     @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([status])
  @@index([createdAt])
  @@map("contact_messages")
}

model Notification {
  id        BigInt   @id @default(autoincrement()) @map("notification_id")
  userId    BigInt   @map("user_id")
  type      String   @db.VarChar(50)
  title     String   @db.VarChar(255)
  message   String
  link      String?  @db.VarChar(500)
  isRead    Boolean  @default(false) @map("is_read")
  createdAt DateTime @default(now()) @map("created_at")

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, isRead])
  @@map("notifications")
}

model AdminUser {
  id          BigInt      @id @default(autoincrement()) @map("admin_id")
  userId      BigInt      @unique @map("user_id")
  role        String      @db.VarChar(30)
  permissions Json?
  isActive    Boolean     @default(true) @map("is_active")
  createdAt   DateTime    @default(now()) @map("created_at")

  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  activityLogs ActivityLog[] @relation("AdminLogs")

  @@index([userId])
  @@index([role])
  @@map("admin_users")
}

model ActivityLog {
  id         BigInt   @id @default(autoincrement()) @map("log_id")
  userId     BigInt?  @map("user_id")
  adminId    BigInt?  @map("admin_id")
  action     String   @db.VarChar(100)
  entityType String?  @map("entity_type") @db.VarChar(50)
  entityId   BigInt?  @map("entity_id")
  details    Json?
  ipAddress  String?  @map("ip_address") @db.VarChar(45)
  userAgent  String?  @map("user_agent") @db.VarChar(500)
  createdAt  DateTime @default(now()) @map("created_at")

  user       User?      @relation("UserLogs", fields: [userId], references: [id], onDelete: SetNull)
  admin      AdminUser? @relation("AdminLogs", fields: [adminId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([adminId])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("activity_logs")
}
